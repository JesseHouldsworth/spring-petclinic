name: Build and Scan with JFrog

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    # Environment variables for consistent build naming across all steps
    env:
      JFROG_CLI_BUILD_NAME: jesseh-spring-petclinic
      JFROG_CLI_BUILD_NUMBER: ${{ github.run_id }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Installs and configures the JFrog CLI with your Artifactory server details
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          server-id: my-jfrog-server
          url: ${{ secrets.JF_RT_URL }}
          user: ${{ secrets.ARTIFACTORY_USERNAME }}
          password: ${{ secrets.ARTIFACTORY_IDENTITY_TOKEN }}

      # Configures Maven to resolve all dependencies from your Artifactory instance
      - name: Configure Maven Repositories
        run: |
          jf mvnc \
            --server-id-resolve=my-jfrog-server \
            --repo-resolve-releases=jesseh-maven-dev-virtual

      # Automatically fixes any code formatting issues to prevent build failures
      - name: Apply Java Formatting
        run: mvn spring-javaformat:apply

      # Wraps the Maven command to resolve dependencies and collect build-info
      - name: Build Application with Maven
        run: |
          jf mvn clean install -DskipTests=true

      # "Shift-left" scan for fast feedback on source code and dependencies
      - name: Run JFrog SAST & SCA Audit
        run: |
          jf audit --fail=false --watches=jesseh-security

      # This is your original, working login action. It correctly handles the full URL.
      - name: Login to JFrog Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.JF_RT_URL }}
          username: ${{ secrets.ARTIFACTORY_USERNAME }}
          password: ${{ secrets.ARTIFACTORY_IDENTITY_TOKEN }}
      
      # Defines the full image name using the registry from your secrets
      - name: Set Docker Image Name
        id: docker_image
        run: |
          DOCKER_REGISTRY=$(echo "${{ secrets.JF_RT_URL }}" | sed 's|https://||')
          echo "image_name=$DOCKER_REGISTRY/jesseh-docker-dev-local/spring-petclinic:${{ github.run_id }}" >> $GITHUB_OUTPUT

      - name: Build Docker Image
        run: |
          docker build -t ${{ steps.docker_image.outputs.image_name }} .

      # Pushes the image using JFrog CLI to add the Docker layers to the build-info
      - name: Push Docker Image
        run: |
          jf docker push ${{ steps.docker_image.outputs.image_name }}

      # Publishes all collected build information to Artifactory
      - name: Publish Build Info
        run: |
          jf rt build-publish

      # Final, comprehensive security scan on the entire build record
      - name: Scan Build with Xray
        run: |
          jf bs --fail=false --vuln